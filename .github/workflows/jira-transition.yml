# .github/workflows/jira-transition.yml
name: Transition Jira issue on PR merge

on:
  pull_request:
    types: [closed]

jobs:
  transition:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Run only whenâ€¦
    #   â€¢ the PR is merged, AND
    #   â€¢ the base branch is NOT auto/**, docs/**, dependabot/**, or renovate/**
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if: >
      github.event.pull_request.merged == true &&
      !startsWith(github.event.pull_request.base.ref, 'auto/') &&
      !startsWith(github.event.pull_request.base.ref, 'docs/') &&
      !startsWith(github.event.pull_request.base.ref, 'dependabot/') &&
      !startsWith(github.event.pull_request.base.ref, 'renovate/')
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ Log in once for all downstream Jira actions
      - name: ğŸ” Jira login
        uses: atlassian/gajira-login@v3 #   â–² v3 has **no inputs** â€“ it reads env vars
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }} # https://<tenant>.atlassian.net
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }} # Atlassian-account email
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }} # 24-char API token

      # 2ï¸âƒ£ Decide the transition based on the PRâ€™s target branch
      - id: vars
        shell: bash
        run: |
          # Detect the Jira key from the PR title, e.g. HEAVB-123
          KEY=$(echo "${{ github.event.pull_request.title }}" | grep -oE '[A-Z]+-[0-9]+')
          # The branch the PR is merging *into*
          TARGET="${{ github.event.pull_request.base.ref }}"
          case "$TARGET" in
            dev)        STATUS="IN REVIEW"   ;;  # feature â†’ dev
            staging)    STATUS="STAGING"     ;;  # dev â†’ staging
            release/*)  STATUS="RELEASE"     ;;  # main â†’ release/*
            main)       STATUS="DONE"        ;;  # production
            *)          STATUS="IN PROGRESS" ;;  # everything else
          esac
          echo "issue=$KEY"         >> "$GITHUB_OUTPUT"
          echo "transition=$STATUS" >> "$GITHUB_OUTPUT"

      # 3ï¸âƒ£ Apply that transition once per merged PR
      - name: ğŸšš Transition Jira issue
        uses: atlassian/gajira-transition@v3
        with:
          issue: ${{ steps.vars.outputs.issue }}
          transition: ${{ steps.vars.outputs.transition }}
