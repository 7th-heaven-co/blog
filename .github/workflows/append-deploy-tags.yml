name: Auto Append Deploy Tags

on:
  push:
    branches: [staging]

jobs:
  parse-commits:
    runs-on: ubuntu-latest
    steps:
      - name: 🧾 Checkout Repo
        uses: actions/checkout@v4

      - name: 🔍 Extract Tags from Commits
        id: extract
        run: |
          git log -n 20 --pretty=format:%s > commits.txt
          echo "Deploy tags:" > deploy-append.txt
          grep -E "#add-post:|#delete-post:|#update-section:" commits.txt >> deploy-append.txt || true

      - name: 📄 Append to deploy-changelog.md
        run: |
          if [ -s deploy-append.txt ]; then
            echo "\n# Auto-appended on $(date +%Y-%m-%d)" >> deploy-changelog.md
            cat deploy-append.txt >> deploy-changelog.md
          fi

      - name: ✅ Commit if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add deploy-changelog.md
          git diff --cached --quiet || git commit -m "chore: auto-update deploy changelog"
          git push
