# .github/workflows/auto-append-deploy-tags.yml
name: Auto Append Deploy Tags

on:
  push:
    branches: [staging]

# The bot must be allowed to write commits *and* open PRs
permissions:
  contents: write
  pull-requests: write

jobs:
  append-deploy-tags:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Check out the current staging tip â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¾ Checkout Repo
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Extract the special deploy tags from the last 20 commits â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Extract Tags from Commits
        id: extract
        run: |
          git log -n 20 --pretty=format:%s > commits.txt
          echo "Deploy tags:" > deploy-append.txt
          # Add lines that match our tag patterns (silently succeed if none)
          grep -E "#add-post:|#delete-post:|#update-section:" commits.txt >> deploy-append.txt || true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Append them to deployâ€‘changelog.md (if there are any) â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“„ Append to deployâ€‘changelog.md
        run: |
          if [ -s deploy-append.txt ]; then
            printf "\n# Autoâ€‘appended on $(date +%Y-%m-%d)\n" >> deploy-changelog.md
            cat deploy-append.txt >> deploy-changelog.md
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. If deployâ€‘changelog.md changed, open a PR to staging â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ¤– Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          # PR branch will be created automatically if it doesnâ€™t exist
          branch: auto/deploy-changelog           # â† what the bot pushes to
          base: staging                           # â† opens PR *into* staging
          commit-message: "chore(deploy): auto-update deploy changelog"
          title: "chore(deploy): autoâ€‘update deploy changelog"
          body: |
            This PR appends the latest deploy tags to **deployâ€‘changelog.md**.
            It was generated automatically by the _Auto Append Deploy Tags_ workflow.
          labels: |
            type:chore
            target:staging
          delete-branch: true                     # cleans up after merge
          signoff: false                          # no Signedâ€‘offâ€‘by needed
          draft: false
