name: Auto Append Deploy Tags

on:
  push:
    branches:
      - staging
      - '!auto/**'
  schedule:
    - cron: '0 9 * * 1'

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: deploy-changelog-${{ github.ref_name }}
  cancel-in-progress: false

env:
  TAG_REGEX: '#add-post:|#delete-post:|#update-section:'

jobs:
  append-deploy-tags:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: staging
        name: üßæ Checkout Repo

      - name: üîç Collect deploy tags
        id: extract
        shell: bash
        run: |
          tags=$(git log -n 20 --pretty=format:%s | grep -E "$TAG_REGEX" || true)
          echo "tags<<EOF" >> "$GITHUB_OUTPUT"
          echo "$tags"       >> "$GITHUB_OUTPUT"
          echo "EOF"         >> "$GITHUB_OUTPUT"

      - name: üìÑ Append to deploy-changelog.md
        if: steps.extract.outputs.tags != ''
        run: |
          clean=$(printf '%s\n' "${{ steps.extract.outputs.tags }}" | sort -u)
          {
            printf "\n# Auto-appended on %s\n" "$(date +%Y-%m-%d)"
            echo  "Deploy tags:"
            printf '* %s\n' $clean
          } >> deploy-changelog.md

      - name: ü§ñ Create pull request
        if: steps.extract.outputs.tags != ''
        uses: peter-evans/create-pull-request@v5
        with:
          branch: auto/deploy-changelog
          base:   staging
          commit-message: "chore(deploy): auto-update deploy changelog"
          title:  "chore(deploy): auto-update deploy changelog"
          body: |
            This PR appends the latest deploy tags to **deploy-changelog.md**.
            (_Auto-generated by **Auto Append Deploy Tags** workflow._)
          labels: |
            type:chore
            target:staging
          delete-branch: true
