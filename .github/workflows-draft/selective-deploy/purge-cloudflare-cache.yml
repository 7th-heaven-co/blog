name: Purge Cloudflare Cache From Paths

on:
  workflow_dispatch:
  push:
    branches: [staging]
    paths:
      - 'scripts/parsed-paths.json'

jobs:
  purge-cache:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout
        uses: actions/checkout@v4

      - name: üìÑ Read parsed-paths.json
        id: read_paths
        run: |
          updated=$(jq -c .updatedPaths scripts/parsed-paths.json)
          deleted=$(jq -c .deletedPaths scripts/parsed-paths.json)
          combined=$(jq -c -n --argjson u "$updated" --argjson d "$deleted" '$u + $d')
          echo "PATHS=$combined" >> $GITHUB_ENV

      - name: ‚ö†Ô∏è Skip if no paths found
        if: env.PATHS == "[]"
        run: echo "No paths to purge. Skipping cache purge."

      - name: üöÄ Trigger Worker Cache Purge
        if: env.PATHS != "[]"
        run: |
          echo "üîç Purging paths: $PATHS"
          curl -X POST "${{ secrets.CF_PURGE_URL }}"             -H "Content-Type: application/json"             -d "{"paths": $PATHS}"