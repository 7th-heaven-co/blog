# ğŸ§ª Test on Staging
# Lints & runs unit tests on every push to `staging` and PRs targeting `staging`.
# Purely a QA gate â€“ it does **not** trigger semanticâ€‘release.

name: "ğŸ§ª Test on Staging"

on:
  push:
    branches: [staging]
  pull_request:
    branches: [staging]

permissions:
  contents: read

jobs:
  test:
    name: "Lint & Unit Tests"
    runs-on: ubuntu-latest
    concurrency:
      group: staging-test-${{ github.ref }}
      cancel-in-progress: true

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Checkout & Cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Lint (Biome) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¹ Biome check
        run: npx biome check .

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Unit tests (Vitest) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§ª Run tests with coverage
        run: npm test -- --coverage

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Upload coverage artefact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¾ Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-staging
          path: coverage

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Optional: send to Codecov â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    #   - name: ğŸ“Š Upload to Codecov
    #     if: success() && env.CODECOV_TOKEN != ''
    #     uses: codecov/codecov-action@v4
    #     with:
    #       token: ${{ secrets.CODECOV_TOKEN }}
